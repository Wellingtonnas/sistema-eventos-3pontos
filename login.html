<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Login — Sistema Cronograma</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      body {
        background: #0d0d0d;
        font-family: Arial;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
        color: white;
      }
      .card {
        background: #1c1c1c;
        padding: 30px;
        width: 320px;
        border-radius: 10px;
        box-shadow: 0 0 25px #000;
        text-align: center;
      }
      h2 {
        margin-bottom: 25px;
        color: #00d2ff;
      }
      select,
      input {
        width: 100%;
        padding: 10px;
        margin-top: 12px;
        border-radius: 6px;
        border: none;
        background: #2c2c2c;
        color: white;
        box-sizing: border-box;
      }
      button {
        width: 100%;
        padding: 12px;
        margin-top: 18px;
        border: none;
        border-radius: 6px;
        background: #008cff;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }
      .visualizar-btn {
        margin-top: 12px;
        background: #444;
      }
      .link-btn {
        margin-top: 12px;
        background: transparent;
        border: 1px solid #333;
        color: #ddd;
      }
      .erro {
        margin-top: 15px;
        color: #ff4444;
        font-size: 14px;
        display: none;
      }
      .ok {
        margin-top: 15px;
        color: #66ff99;
        font-size: 14px;
        display: none;
      }

      .logo-topo {
        display: block;
        height: 42px;
        width: auto;
        margin: 10px auto 0;
        opacity: 0.95;
      }

      .dev-footer {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 13px;
        color: rgba(255, 255, 255, 0.6);
        z-index: 9999;
        pointer-events: none;
        white-space: nowrap;
      }

      /* ===== Modal simples ===== */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 99999;
      }
      .modal.show {
        display: flex;
      }
      .modal-box {
        width: 360px;
        max-width: 92vw;
        background: #1c1c1c;
        border: 1px solid #333;
        border-radius: 10px;
        box-shadow: 0 0 25px #000;
        padding: 18px;
        text-align: left;
      }
      .modal-box h3 {
        margin: 0 0 10px 0;
        color: #00d2ff;
      }
      .row-actions {
        display: flex;
        gap: 10px;
        margin-top: 14px;
      }
      .row-actions button {
        margin-top: 0;
      }
      .btn-cancel {
        background: #333;
      }
      .hint {
        font-size: 12px;
        color: #bbb;
        margin-top: 10px;
        line-height: 1.3;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <img
        src="assets/logo-3pontos.png"
        alt="3 Pontos Stands"
        class="logo-topo"
      />
      <h2>GESTÃO DE EVENTOS E PROJETOS</h2>

      <select id="tipoAcesso">
        <option value="admin">Admin</option>
        <option value="producao">Produção</option>
      </select>

      <input
        id="loginUser"
        type="email"
        placeholder="Email (ex: alexandre@3pontos.com)"
      />
      <input id="loginPass" type="password" placeholder="Senha" />

      <button id="btnEntrar" type="button">Entrar</button>

      <button class="visualizar-btn" id="btnVisual" type="button">
        Entrar como Visualizador
      </button>

      <!-- ✅ NOVO: Trocar senha (antes de entrar no sistema) -->
      <button class="link-btn" id="btnTrocarSenha" type="button">
        Trocar senha
      </button>

      <div class="erro" id="msgErro"></div>
      <div class="ok" id="msgOk"></div>
    </div>

    <!-- ✅ Modal de troca de senha -->
    <div class="modal" id="modalSenha">
      <div class="modal-box">
        <h3>Trocar senha</h3>

        <input id="csEmail" type="email" placeholder="Email" />
        <input id="csSenhaAtual" type="password" placeholder="Senha atual" />
        <input id="csNovaSenha" type="password" placeholder="Nova senha" />
        <input
          id="csConfirma"
          type="password"
          placeholder="Confirmar nova senha"
        />

        <div class="row-actions">
          <button class="btn-cancel" id="btnCancelarTroca" type="button">
            Cancelar
          </button>
          <button id="btnConfirmarTroca" type="button">Confirmar</button>
        </div>

        <div class="hint">
          Dica: use uma senha com pelo menos 8 caracteres (misture letras e
          números).
        </div>
      </div>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabaseClient.js"></script>

    <script>
      // ========= Helpers UI =========
      const msgErro = document.getElementById("msgErro");
      const msgOk = document.getElementById("msgOk");

      function showError(text) {
        msgOk.style.display = "none";
        msgErro.innerText = text;
        msgErro.style.display = "block";
      }

      function showOk(text) {
        msgErro.style.display = "none";
        msgOk.innerText = text;
        msgOk.style.display = "block";
      }

      // ========= Login principal =========
      async function fazerLogin(email, password, tipoEscolhido) {
        msgErro.style.display = "none";
        msgOk.style.display = "none";

        try {
          // 1) Auth
          const { data, error } =
            await window.supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
          if (error) throw new Error("Auth: " + error.message);

          const userId = data.user.id;

          // 2) Buscar perfil
          const { data: perfil, error: perfilErr } = await window.supabaseClient
            .from("profiles")
            .select("nome, role")
            .eq("id", userId)
            .single();

          if (perfilErr) throw new Error("Profiles: " + perfilErr.message);
          if (!perfil) throw new Error("Profiles: perfil não encontrado.");

          // 3) Validar tipo de acesso vs role
          const roleNormalizada =
            perfil.role === "superadmin" ? "admin" : perfil.role;

          if (tipoEscolhido && roleNormalizada !== tipoEscolhido) {
            await window.supabaseClient.auth.signOut();
            throw new Error(
              `Permissão: seu perfil é "${roleNormalizada}" e você selecionou "${tipoEscolhido}".`,
            );
          }

          // 4) Cache pro frontend
          localStorage.setItem("nivelAcesso", roleNormalizada);
          localStorage.setItem("usuarioLogado", perfil.nome);

          showOk("Login OK. Redirecionando...");
          window.location.href = "cronograma.html";
        } catch (e) {
          console.error("ERRO LOGIN:", e);
          showError(e.message || "Login inválido ou perfil sem permissão.");
        }
      }

      // ========= Troca de senha ANTES de entrar =========
      async function trocarSenhaAntesDeEntrar(email, senhaAtual, novaSenha) {
        // 1) autentica com a senha atual
        const { error: e1 } =
          await window.supabaseClient.auth.signInWithPassword({
            email,
            password: senhaAtual,
          });
        if (e1) throw new Error("Senha atual incorreta.");

        // 2) troca senha
        const { error: e2 } = await window.supabaseClient.auth.updateUser({
          password: novaSenha,
        });
        if (e2) throw new Error("Erro ao trocar senha: " + e2.message);

        // 3) desloga (pra pessoa entrar de novo com a nova senha)
        await window.supabaseClient.auth.signOut();
      }

      // ========= Eventos =========
      document
        .getElementById("btnEntrar")
        .addEventListener("click", async () => {
          const tipo = document.getElementById("tipoAcesso").value;
          const email = document.getElementById("loginUser").value.trim();
          const pass = document.getElementById("loginPass").value;

          if (!email || !pass) return showError("Preencha email e senha.");
          await fazerLogin(email, pass, tipo);
        });

      // Enter no teclado
      document.addEventListener("keydown", (e) => {
        if (e.key === "Enter") document.getElementById("btnEntrar").click();
      });

      // Visualizador
      document
        .getElementById("btnVisual")
        .addEventListener("click", async () => {
          const email = "visual@3pontos.com";
          const pass = prompt("Senha do Visualizador:");
          if (!pass) return;

          await fazerLogin(email, pass, "visual");
        });

      // ===== Modal troca senha =====
      const modalSenha = document.getElementById("modalSenha");
      const btnTrocarSenha = document.getElementById("btnTrocarSenha");
      const btnCancelarTroca = document.getElementById("btnCancelarTroca");
      const btnConfirmarTroca = document.getElementById("btnConfirmarTroca");

      function abrirModalSenha() {
        // pré-preenche com o email digitado no login (se tiver)
        document.getElementById("csEmail").value =
          document.getElementById("loginUser").value.trim() || "";
        document.getElementById("csSenhaAtual").value = "";
        document.getElementById("csNovaSenha").value = "";
        document.getElementById("csConfirma").value = "";
        modalSenha.classList.add("show");
      }

      function fecharModalSenha() {
        modalSenha.classList.remove("show");
      }

      btnTrocarSenha.addEventListener("click", abrirModalSenha);
      btnCancelarTroca.addEventListener("click", fecharModalSenha);

      btnConfirmarTroca.addEventListener("click", async () => {
        msgErro.style.display = "none";
        msgOk.style.display = "none";

        const email = document.getElementById("csEmail").value.trim();
        const senhaAtual = document.getElementById("csSenhaAtual").value;
        const novaSenha = document.getElementById("csNovaSenha").value;
        const confirma = document.getElementById("csConfirma").value;

        if (!email || !senhaAtual || !novaSenha || !confirma)
          return showError("Preencha todos os campos da troca de senha.");

        if (novaSenha.length < 8)
          return showError("A nova senha deve ter pelo menos 8 caracteres.");

        if (novaSenha !== confirma)
          return showError("A confirmação não confere com a nova senha.");

        try {
          await trocarSenhaAntesDeEntrar(email, senhaAtual, novaSenha);
          fecharModalSenha();
          showOk("Senha alterada! Agora entre com a nova senha.");
        } catch (e) {
          console.error("TROCA SENHA:", e);
          showError(e.message || "Não foi possível trocar a senha.");
        }
      });

      // clicar fora fecha
      modalSenha.addEventListener("click", (e) => {
        if (e.target === modalSenha) fecharModalSenha();
      });
    </script>

    <footer class="dev-footer">
      3P Control — desenvolvido por Wellington Carneiro
    </footer>
  </body>
</html>
